# Telegram News Auto-Publisher Bot

Автоматизированная система для мониторинга, обработки и публикации новостей из Telegram-каналов с использованием AI (DeepSeek) для перевода и форматирования.

## Возможности

- **Автоматический мониторинг** Telegram-канала с новостями
- **Парсинг новостных статей** по ссылкам из сообщений (newspaper3k)
- **AI-обработка контента** через DeepSeek API:
  - Перевод на русский язык
  - Стилистическое оформление
  - Форматирование для Telegram (Markdown)
- **Умная очередь публикаций**:
  - Планирование по расписанию (по умолчанию: 8:00, 12:00, 16:00, 20:00)
  - Автоопределение срочных новостей по ключевым словам ("молния", "breaking")
  - Срочные новости публикуются немедленно
  - По 1 новости в каждый временной слот
  - Поздние новости (после 20:00) переносятся на следующий день
- **Команды управления**:
  - `/status` - статус очереди
  - `/queue` - список новостей в очереди
  - `/publish_now <id>` - немедленная публикация
  - `/clear_queue` - очистка очереди
- **База данных SQLite** для хранения очереди новостей

## Архитектура

```
┌─────────────────┐
│  Telegram API   │
│  (Source Channel)│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Telegram Handler│
│  - Мониторинг   │
│  - Детектор     │
│    срочности    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌──────────────┐
│  News Parser    │──────│ DeepSeek API │
│  (newspaper3k)  │      │  (AI Process)│
└────────┬────────┘      └──────────────┘
         │
         ▼
┌─────────────────┐
│   SQLite DB     │
│  (News Queue)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  APScheduler    │
│  (8,12,16,20)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Telegram API   │
│ (Target Channel)│
└─────────────────┘
```

## Требования

- Python 3.8+
- Telegram Bot Token
- DeepSeek API Key
- Доступ к исходному и целевому Telegram-каналам

## Установка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd TelegaAutoPublishNEWS
```

### 2. Создание виртуального окружения

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 4. Конфигурация

Скопируйте `.env.example` в `.env` и заполните необходимые данные:

```bash
cp .env.example .env
```

Отредактируйте `.env`:

```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_bot_token_here
SOURCE_CHANNEL_ID=@your_source_channel  # или -100123456789
TARGET_CHANNEL_ID=@your_target_channel  # или -100123456789

# DeepSeek API Configuration
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions

# Bot Settings
PUBLISH_SCHEDULE=8,12,16,20
URGENT_KEYWORDS=молния,breaking
ADMIN_USER_ID=your_telegram_user_id
```

### 5. Получение необходимых токенов и ID

#### Telegram Bot Token:
1. Напишите [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте `/newbot`
3. Следуйте инструкциям и получите токен

#### ID канала:
1. Добавьте бота в канал как администратора
2. Для публичного канала: `@channel_username`
3. Для приватного канала: используйте ID вида `-100123456789`
   - Можно получить через [@username_to_id_bot](https://t.me/username_to_id_bot)

#### DeepSeek API Key:
1. Зарегистрируйтесь на [DeepSeek](https://platform.deepseek.com/)
2. Создайте API ключ в разделе API Keys

#### Ваш User ID (для команд администратора):
1. Напишите [@userinfobot](https://t.me/userinfobot)
2. Скопируйте ваш ID

## Запуск

### Режим polling (рекомендуется для начала)

```bash
python app.py
```

Бот будет работать в режиме long polling, получая обновления напрямую от Telegram.

### Режим Flask + webhook (для продакшена)

```bash
python app.py flask
```

Требуется настройка HTTPS и домена для webhook.

## Команды бота

Отправьте боту в личные сообщения:

- `/start` - Информация о боте и расписании
- `/help` - Список всех команд
- `/status` - Статус очереди новостей (количество, следующие публикации)
- `/queue` - Полный список новостей в очереди
- `/publish_now <id>` - Опубликовать новость с ID немедленно (только для администратора)
- `/clear_queue` - Очистить очередь (только для администратора)

## Как это работает

### 1. Мониторинг канала

Бот отслеживает сообщения в исходном канале (`SOURCE_CHANNEL_ID`) и извлекает из них URL-ссылки.

**Важно:** Бот обрабатывает только новые сообщения, появившиеся ПОСЛЕ его запуска. Все старые сообщения из канала игнорируются, чтобы избежать обработки всей истории канала.

### 2. Парсинг статей

Для каждой найденной ссылки:
- Загружается полный текст статьи (newspaper3k)
- Извлекаются заголовок, автор, дата, основной текст

### 3. Проверка срочности

Бот проверяет заголовок и текст статьи на наличие ключевых слов (`URGENT_KEYWORDS`):
- Если найдены - новость помечается как срочная
- Срочные новости публикуются немедленно

### 4. Обработка через DeepSeek

Статья отправляется в DeepSeek API для:
- Перевода на русский язык (если нужно)
- Форматирования в новостном стиле
- Разметки Markdown для Telegram

### 5. Добавление в очередь

Обработанная новость добавляется в SQLite базу данных с:
- Временем публикации (следующий доступный слот)
- Статусом (pending/published/failed)
- Флагом срочности

### 6. Публикация по расписанию

APScheduler запускает задачу публикации в каждый указанный час:
- Извлекается 1 новость из очереди
- Публикуется в целевой канал (`TARGET_CHANNEL_ID`)
- Статус меняется на "published"

## Настройка расписания

Измените `PUBLISH_SCHEDULE` в `.env`:

```env
# Публикация каждые 4 часа
PUBLISH_SCHEDULE=0,4,8,12,16,20

# Публикация каждый час с 9 до 18
PUBLISH_SCHEDULE=9,10,11,12,13,14,15,16,17,18

# Публикация только утром и вечером
PUBLISH_SCHEDULE=9,18
```

## Настройка ключевых слов срочности

Измените `URGENT_KEYWORDS` в `.env`:

```env
# Расширенный список
URGENT_KEYWORDS=молния,breaking,срочно,важно,экстренно,внимание,alert,urgent
```

## Логирование

Логи сохраняются в файл `bot.log` и выводятся в консоль.

Уровни логирования:
- **INFO** - нормальная работа
- **WARNING** - предупреждения (статья не прошла валидацию)
- **ERROR** - ошибки (не удалось опубликовать)

## База данных

SQLite база `news_queue.db` создается автоматически.

Структура таблицы `news_queue`:
- `id` - уникальный ID
- `url` - URL статьи
- `title` - заголовок
- `original_text` - исходный текст
- `processed_text` - обработанный текст
- `scheduled_time` - время публикации
- `status` - статус (pending/published/failed)
- `is_urgent` - флаг срочности
- `created_at` - время добавления
- `published_at` - время публикации

## Структура проекта

```
TelegaAutoPublishNEWS/
├── app.py                  # Основное приложение
├── config.py               # Конфигурация
├── database.py             # Работа с БД
├── scheduler.py            # Планировщик публикаций
├── telegram_handler.py     # Обработчик Telegram
├── news_parser.py          # Парсер новостей
├── deepseek_client.py      # Клиент DeepSeek API
├── requirements.txt        # Зависимости
├── .env                    # Переменные окружения (не в git)
├── .env.example            # Пример конфигурации
├── .gitignore              # Исключения для git
├── README.md               # Документация
├── bot.log                 # Лог-файл (создается автоматически)
└── news_queue.db           # База данных (создается автоматически)
```

## Устранение неполадок

### Бот не получает сообщения из канала

- Убедитесь, что бот добавлен в канал как администратор
- Проверьте правильность `SOURCE_CHANNEL_ID`
- Для приватных каналов используйте числовой ID (-100...)

### Ошибки при парсинге статей

- Некоторые сайты могут блокировать автоматический парсинг
- newspaper3k может не поддерживать определенные форматы сайтов

### DeepSeek API ошибки

- Проверьте правильность `DEEPSEEK_API_KEY`
- Убедитесь в наличии средств на балансе DeepSeek
- Проверьте лимиты API

### Новости не публикуются по расписанию

- Убедитесь, что бот запущен и не остановлен
- Проверьте логи `bot.log` на наличие ошибок
- Проверьте, что в очереди есть новости со статусом "pending"

## Безопасность

- Никогда не коммитьте `.env` файл в репозиторий
- Используйте надежные API ключи
- Ограничьте доступ к команд ам администратора через `ADMIN_USER_ID`
- Регулярно обновляйте зависимости

## Лицензия

MIT

## Поддержка

По вопросам и предложениям создавайте Issues в GitHub репозитории.
