# Telegram News Auto-Publisher Bot

Автоматизированная система для мониторинга, обработки и публикации новостей из Telegram-каналов с использованием AI (DeepSeek) для перевода и форматирования.

## Возможности

- **Автоматический мониторинг** Telegram-канала с новостями
- **Парсинг новостных статей** по ссылкам из сообщений (newspaper3k)
- **AI-обработка контента** через DeepSeek API:
  - Перевод на русский язык
  - Стилистическое оформление
  - Форматирование для Telegram (Markdown)
- **Умная очередь публикаций**:
  - Планирование по расписанию (по умолчанию: 8:00, 12:00, 16:00, 20:00)
  - Автоопределение срочных новостей по ключевым словам ("молния", "breaking")
  - Срочные новости публикуются немедленно
  - По 1 новости в каждый временной слот
  - Поздние новости (после 20:00) переносятся на следующий день
- **Команды управления**:
  - `/status` - статус очереди
  - `/queue` - список новостей в очереди
  - `/publish_now <id>` - немедленная публикация
  - `/clear_queue` - очистка очереди
  - `/view <id>` - предпросмотр статьи
  - `/rewrite <id>` - переписать статью с новым стилем
  - `/config` - показать настройки бота
  - `/set_config <key> <value>` - изменить настройку
  - `/set_style <style>` - изменить стиль написания
  - `/get_style` - показать текущий стиль
- **База данных PostgreSQL** (Aiven или самостоятельная) для хранения очереди и конфигурации
- **Динамическая конфигурация** через базу данных без перезапуска
- **Несколько стилей написания**: informative, ironic, cynical, playful, mocking
- **Контроль длины текста**: short (~1000 символов), medium (~2000), long (~3000)
- **Автоматическая очистка** старых опубликованных статей (7 дней)

## Архитектура

```
┌─────────────────┐
│  Telegram API   │
│  (Source Channel)│
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Telegram Handler│
│  - Мониторинг   │
│  - Детектор     │
│    срочности    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐      ┌──────────────┐
│  News Parser    │──────│ DeepSeek API │
│  (newspaper3k)  │      │  (AI Process)│
└────────┬────────┘      │  + Styles    │
         │               └──────────────┘
         ▼
┌─────────────────┐
│  PostgreSQL DB  │
│ (Aiven/Local)   │
│  - News Queue   │
│  - Bot Config   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  APScheduler    │
│  (8,12,16,20)   │
│  + Cleanup 3:00 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Telegram API   │
│ (Target Channel)│
└─────────────────┘
```

## Требования

- Python 3.8+
- Telegram Bot Token
- DeepSeek API Key
- Доступ к исходному и целевому Telegram-каналам

## Установка

### 1. Клонирование репозитория

```bash
git clone <repository-url>
cd TelegaAutoPublishNEWS
```

### 2. Создание виртуального окружения

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows
```

### 3. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 4. Конфигурация

Скопируйте `.env.example` в `.env` и заполните необходимые данные:

```bash
cp .env .env
```

Отредактируйте `.env`:

```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_bot_token_here
SOURCE_CHANNEL_ID=@your_source_channel  # или -100123456789
TARGET_CHANNEL_ID=@your_target_channel  # или -100123456789
ADMIN_USER_ID=your_telegram_user_id

# DeepSeek API Configuration
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions

# PostgreSQL Database (Aiven или самостоятельное развертывание)
# Вариант 1: Полный URL (рекомендуется для Aiven)
DATABASE_URL=postgresql://user:password@host:port/dbname?sslmode=require

# Вариант 2: Отдельные параметры (если DATABASE_URL не указан)
DB_HOST=your-database-host.com
DB_PORT=5432
DB_NAME=news_queue
DB_USER=postgres
DB_PASSWORD=your_password
DB_SSLMODE=require  # для Aiven обязательно require

# Bot Settings (могут быть изменены через команды бота без перезапуска)
PUBLISH_SCHEDULE=8,12,16,20
URGENT_KEYWORDS=молния,breaking
ARTICLE_STYLE=informative  # informative, ironic, cynical, playful, mocking
TEXT_LENGTH=medium  # short, medium, long
MAX_ARTICLES_PER_RUN=5
CHECK_INTERVAL=60
MONITOR_FROM_DATE=  # Оставьте пустым для мониторинга с момента запуска, или укажите дату в формате YYYY-MM-DD HH:MM:SS

# Flask Settings (для webhook режима)
FLASK_HOST=0.0.0.0
FLASK_PORT=5000
WEBHOOK_URL=https://your-domain.com
WEBHOOK_PATH=/webhook
```

### 5. Получение необходимых токенов и ID

#### Telegram Bot Token:
1. Напишите [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте `/newbot`
3. Следуйте инструкциям и получите токен

#### ID канала:
1. Добавьте бота в канал как администратора
2. Для публичного канала: `@channel_username`
3. Для приватного канала: используйте ID вида `-100123456789`
   - Можно получить через [@username_to_id_bot](https://t.me/username_to_id_bot)

#### DeepSeek API Key:
1. Зарегистрируйтесь на [DeepSeek](https://platform.deepseek.com/)
2. Создайте API ключ в разделе API Keys

#### Ваш User ID (для команд администратора):
1. Напишите [@userinfobot](https://t.me/userinfobot)
2. Скопируйте ваш ID

## Запуск

### Режим polling (рекомендуется для разработки и простых развертываний)

```bash
python app.py
```

**Преимущества polling:**
- Легко настроить, не требует HTTPS
- Работает за NAT/firewall
- Подходит для разработки и небольших развертываний
- Не требует публичного IP или домена

### Режим webhook (рекомендуется для продакшена)

```bash
python app.py webhook
```

**Требования для webhook:**
- HTTPS домен с действительным SSL сертификатом
- Публичный IP или домен, доступный из интернета
- Настройка reverse proxy (nginx/Apache) для SSL терминации
- Telegram поддерживает порты: 443, 80, 88, 8443

**Преимущества webhook:**
- Более эффективен для высоконагруженных сценариев
- Меньшая задержка обработки сообщений
- Telegram отправляет обновления напрямую на ваш сервер

## Команды бота

Отправьте боту в личные сообщения:

### Публичные команды (доступны всем)

- `/start` - Информация о боте и расписании
- `/help` - Список всех команд
- `/status` - Статус очереди новостей (количество, следующие публикации)
- `/queue` - Полный список новостей в очереди
- `/get_style` - Показать текущий стиль написания статей

### Команды администратора (требуют ADMIN_USER_ID)

**Управление публикациями:**
- `/publish_now <id>` - Опубликовать новость с ID немедленно
- `/clear_queue` - Очистить очередь новостей
- `/view <id>` - Предпросмотр статьи по ID перед публикацией
- `/rewrite <id>` - Переписать статью с новым стилем и/или длиной

**Управление конфигурацией:**
- `/config` - Показать все настройки бота из базы данных
- `/set_config <key> <value>` - Обновить настройку в базе данных
  - Пример: `/set_config ARTICLE_STYLE ironic`
  - Пример: `/set_config PUBLISH_SCHEDULE 6,10,14,18,22`
- `/reload_config` - Перезагрузить настройки из БД без перезапуска
- `/set_style <style>` - Изменить стиль написания статей
  - Доступные стили: informative, ironic, cynical, playful, mocking

## Как это работает

### 1. Мониторинг канала

Бот отслеживает сообщения в исходном канале (`SOURCE_CHANNEL_ID`) и извлекает из них URL-ссылки.

**Важно:** Бот обрабатывает только новые сообщения, появившиеся ПОСЛЕ его запуска. Все старые сообщения из канала игнорируются, чтобы избежать обработки всей истории канала.

### 2. Парсинг статей

Для каждой найденной ссылки:
- Загружается полный текст статьи (newspaper3k)
- Извлекаются заголовок, автор, дата, основной текст

### 3. Проверка срочности

Бот проверяет заголовок и текст статьи на наличие ключевых слов (`URGENT_KEYWORDS`):
- Если найдены - новость помечается как срочная
- Срочные новости публикуются немедленно

### 4. Обработка через DeepSeek

Статья отправляется в DeepSeek API для:
- Перевода на русский язык (если нужно)
- Форматирования в новостном стиле
- Разметки Markdown для Telegram

### 5. Добавление в очередь

Обработанная новость добавляется в SQLite базу данных с:
- Временем публикации (следующий доступный слот)
- Статусом (pending/published/failed)
- Флагом срочности

### 6. Публикация по расписанию

APScheduler запускает задачу публикации в каждый указанный час:
- Извлекается 1 новость из очереди
- Публикуется в целевой канал (`TARGET_CHANNEL_ID`)
- Статус меняется на "published"

## Управление конфигурацией

**Важно:** Конфигурация бота теперь хранится в базе данных PostgreSQL и может быть изменена без перезапуска бота!

### Приоритет настроек
1. **База данных** (наивысший приоритет) - настройки из таблицы `bot_config`
2. **Переменные окружения** (.env файл) - используются как значения по умолчанию при первом запуске

### Изменяемые настройки (через команды бота)

Используйте `/set_config <key> <value>` для изменения настроек в реальном времени:

```
/set_config PUBLISH_SCHEDULE 6,10,14,18,22
/set_config URGENT_KEYWORDS молния,breaking,срочно,экстренно
/set_config ARTICLE_STYLE ironic
/set_config TEXT_LENGTH long
/set_config MAX_ARTICLES_PER_RUN 10
```

**Доступные настройки:**
- `PUBLISH_SCHEDULE` - часы публикации через запятую (требует перезапуск для APScheduler)
- `URGENT_KEYWORDS` - ключевые слова для срочных новостей
- `ARTICLE_STYLE` - стиль написания (informative, ironic, cynical, playful, mocking)
- `TEXT_LENGTH` - длина текста (short, medium, long)
- `MAX_ARTICLES_PER_RUN` - максимум статей на обработку
- `CHECK_INTERVAL` - интервал проверок в секундах
- `MONITOR_FROM_DATE` - дата начала мониторинга (YYYY-MM-DD HH:MM:SS)

### Стили написания статей

Бот поддерживает 5 стилей написания:

1. **informative** (по умолчанию) - Объективный журналистский стиль
   - Нейтральный тон без эмоций
   - Только факты: кто, что, где, когда, почему
   - Структурированное изложение

2. **ironic** - Ироничный стиль с сарказмом
   - Кавычки для иронических эпитетов
   - Риторические вопросы
   - Контрастные сопоставления

3. **cynical** - Циничный и недоверчивый стиль
   - Сомнения в официальных заявлениях
   - Маркеры недоверия: "якобы", "по словам", "утверждается"
   - Указание на скрытые мотивы

4. **playful** - Легкий развлекательный стиль
   - Разговорная речь и современный сленг
   - Яркие метафоры
   - Шутливые комментарии

5. **mocking** - Стебно-сатирический стиль
   - Гиперболы и абсурдные преувеличения
   - Саркастические комментарии
   - Высмеивание глупостей и противоречий

**Изменение стиля:**
```
/set_style ironic
/get_style  # проверить текущий стиль
```

### Контроль длины текста

Три варианта длины обработанных статей:
- **short** - ~1000 символов (краткая сводка)
- **medium** - ~2000 символов (стандартная статья)
- **long** - ~3000 символов (подробная статья)

**Изменение длины:**
```
/set_config TEXT_LENGTH short
```

### Примеры настройки расписания

```env
# Публикация каждые 4 часа
PUBLISH_SCHEDULE=0,4,8,12,16,20

# Публикация каждый час с 9 до 18
PUBLISH_SCHEDULE=9,10,11,12,13,14,15,16,17,18

# Публикация только утром и вечером
PUBLISH_SCHEDULE=9,18
```

**Примечание:** Изменение `PUBLISH_SCHEDULE` требует перезапуска бота для обновления задач APScheduler.

## Логирование

Логи сохраняются в файл `bot.log` и выводятся в консоль.

Уровни логирования:
- **INFO** - нормальная работа
- **WARNING** - предупреждения (статья не прошла валидацию)
- **ERROR** - ошибки (не удалось опубликовать)

## База данных

Бот использует **PostgreSQL** (рекомендуется Aiven для облачного хостинга).

### Настройка PostgreSQL (Aiven)

1. Создайте PostgreSQL сервис на [Aiven Console](https://console.aiven.io/)
2. Скопируйте Service URI из панели управления Aiven
3. Добавьте в `.env`:
   ```env
   DATABASE_URL=postgresql://user:password@host:port/defaultdb?sslmode=require
   ```

**Альтернатива:** Используйте отдельные параметры, если DATABASE_URL не доступен:
```env
DB_HOST=your-aiven-host.aivencloud.com
DB_PORT=12345
DB_NAME=defaultdb
DB_USER=avnadmin
DB_PASSWORD=your_password
DB_SSLMODE=require
```

### Структура базы данных

#### Таблица `news_queue` (очередь статей):
- `id` - SERIAL PRIMARY KEY (автоинкремент)
- `url` - TEXT UNIQUE NOT NULL (предотвращает дубликаты)
- `title` - TEXT
- `original_text` - TEXT
- `processed_text` - TEXT
- `scheduled_time` - TIMESTAMP (время публикации)
- `status` - TEXT DEFAULT 'pending' (pending/published/failed)
- `is_urgent` - BOOLEAN DEFAULT FALSE (флаг немедленной публикации)
- `created_at` - TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- `published_at` - TIMESTAMP
- `updated_at` - TIMESTAMP

**Индексы для производительности:**
- `idx_status` на (status)
- `idx_scheduled_time` на (scheduled_time)
- `idx_is_urgent` на (is_urgent)
- `idx_status_scheduled` композитный на (status, scheduled_time)
- `idx_published_at` на (published_at) - для запросов очистки

#### Таблица `bot_config` (конфигурация бота):
- `key` - TEXT PRIMARY KEY (имя настройки)
- `value` - TEXT NOT NULL (значение настройки)
- `updated_at` - TIMESTAMP DEFAULT CURRENT_TIMESTAMP

**Настройки по умолчанию** (автоматически инициализируются):
- `PUBLISH_SCHEDULE` = 8,12,16,20
- `URGENT_KEYWORDS` = молния,breaking
- `MAX_ARTICLES_PER_RUN` = 5
- `ARTICLE_STYLE` = informative
- `TEXT_LENGTH` = medium
- `CHECK_INTERVAL` = 60
- `MONITOR_FROM_DATE` = '' (пусто)

### Особенности подключения

- **Connection pooling** (1-10 соединений) для оптимальной производительности
- Автоматическое управление соединениями с контекстными менеджерами
- Откат транзакций при ошибках
- Поддержка SSL/TLS (обязательно для Aiven)
- Graceful cleanup при остановке

### Автоматическая очистка

Опубликованные статьи старше **7 дней** автоматически удаляются ежедневно в 3:00 утра для поддержания размера базы данных.

## Структура проекта

```
TelegaAutoPublishNEWS/
├── app.py                  # Основное приложение (Flask + APScheduler)
├── config.py               # Конфигурация (с поддержкой БД)
├── database.py             # Работа с PostgreSQL БД (Aiven/Local)
├── scheduler.py            # Планировщик публикаций
├── telegram_handler.py     # Обработчик Telegram (polling/webhook)
├── news_parser.py          # Парсер новостей (newspaper3k)
├── deepseek_client.py      # Клиент DeepSeek API (с поддержкой стилей)
├── requirements.txt        # Зависимости Python
├── .env                    # Переменные окружения (не в git)
├── .env.example            # Пример конфигурации
├── .gitignore              # Исключения для git
├── README.md               # Документация пользователя
├── CLAUDE.md               # Документация для разработчиков
├── MIGRATION.md            # Инструкции по миграции
└── bot.log                 # Лог-файл (создается автоматически)
```

## Устранение неполадок

### Бот не получает сообщения из канала

- Убедитесь, что бот добавлен в канал как администратор
- Проверьте правильность `SOURCE_CHANNEL_ID`
- Для приватных каналов используйте числовой ID (-100...)

### Ошибки при парсинге статей

- Некоторые сайты могут блокировать автоматический парсинг
- newspaper3k может не поддерживать определенные форматы сайтов

### DeepSeek API ошибки

- Проверьте правильность `DEEPSEEK_API_KEY`
- Убедитесь в наличии средств на балансе DeepSeek
- Проверьте лимиты API

### Новости не публикуются по расписанию

- Убедитесь, что бот запущен и не остановлен
- Проверьте логи `bot.log` на наличие ошибок
- Проверьте, что в очереди есть новости со статусом "pending"

### Ошибка "Conflict: can't use getUpdates method while webhook is active"

Эта ошибка возникает, если ранее для бота был настроен webhook:
- Бот автоматически удаляет webhook при запуске
- Если ошибка повторяется, можно вручную удалить webhook через BotFather или API:
  ```bash
  curl https://api.telegram.org/bot<YOUR_BOT_TOKEN>/deleteWebhook
  ```
- Убедитесь, что не запущено несколько экземпляров бота одновременно

### Проблемы с подключением к PostgreSQL

**Ошибка подключения к Aiven:**
- Проверьте правильность DATABASE_URL или DB_* параметров
- Убедитесь в наличии `sslmode=require` для Aiven
- Проверьте правила firewall и сетевую доступность к хосту БД
- Убедитесь что сервис PostgreSQL запущен в Aiven Console
- Проверьте корректность логина/пароля

**Ошибка создания connection pool:**
- Увеличьте лимит соединений в настройках PostgreSQL (если self-hosted)
- Для Aiven: проверьте план подписки (есть ли ограничения на соединения)
- Проверьте логи `bot.log` для деталей ошибки

### Проблемы с конфигурацией

**Изменения в `/set_config` не применяются:**
- Используйте `/reload_config` для немедленной перезагрузки настроек
- Изменение `PUBLISH_SCHEDULE` требует полного перезапуска бота
- Проверьте логи на наличие ошибок при сохранении в БД
- Используйте `/config` чтобы убедиться что изменения сохранены

**Стиль написания не меняется:**
- Убедитесь что используете правильное имя стиля (informative, ironic, cynical, playful, mocking)
- Используйте `/get_style` для проверки текущего стиля
- Новый стиль применяется только к НОВЫМ статьям после изменения
- Для уже обработанных статей используйте `/rewrite <id>`

## Безопасность

- Никогда не коммитьте `.env` файл в репозиторий
- Используйте надежные API ключи
- Ограничьте доступ к команд ам администратора через `ADMIN_USER_ID`
- Регулярно обновляйте зависимости

## Лицензия

MIT

## Поддержка

По вопросам и предложениям создавайте Issues в GitHub репозитории.
